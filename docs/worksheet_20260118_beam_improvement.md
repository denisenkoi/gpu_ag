# BEAM Optimization Research - Worksheet

## [2026-01-17 17:00] Начало исследования BEAM алгоритмов

### Контекст

Создан worktree `gpu_ag_2` на ветке `beam_ag_optimization` для изолированного исследования BEAM методов.

### Текущее состояние

**Лучший результат:** LOOKBACK_BEAM_V2
- RMSE: 6.25m (улучшение 9.8% от baseline 6.93m)
- Wells improved: 53/100
- Время: 537s (~5.4s/well)

**Проблема:** Только 53% скважин улучшены. Нужно понять почему остальные хуже.

### Предыдущие находки (из основного worksheet)

1. **STD(bin_means) лучшая метрика для self-correlation** - REF wins 95%
2. **IQR не работает** - алгоритм "обманывает" её
3. **Сглаживание savgol(51, 3)** синхронизировано между objective.py и визуализатором
4. **LOOKBACK_BEAM_V2 в 14x быстрее V1** благодаря vectorization

### Ключевые параметры BEAM

```python
# Текущие значения в lookback_beam_v2.py:
stage_size = 2        # сегментов за stage
beam_width = 100      # кандидатов в beam
pearson_lookback = 300  # точек для Pearson/MSE
std_lookback = 600    # точек для Self-corr STD
score_ratio = 1.0     # 100% по score (STD не используется для селекции)
```

### Направления исследования

1. **Визуальный анализ плохих скважин**
   - Запустить на конкретных скважинах и сравнить с BruteForce
   - Понять паттерны: длина, сложность, какие блоки ломаются

2. **Эксперименты с параметрами**
   - beam_width: 100 → 200 → 500
   - score_ratio: 1.0 → 0.5 (добавить STD selection)
   - lookback distances

3. **Анализ накопления ошибок**
   - Трассировать scores/errors по stages
   - Найти точку где beam "сходит с рельс"

---

## [2026-01-17 17:45] Анализ Well498 - BEAM vs BF

### Сравнение результатов

| Алгоритм | Well498 opt_error | Углы первых сегментов |
|----------|-------------------|----------------------|
| BF (5.37m run) | **+0.20m** | [1.31, 2.71, 3.31, 1.71, 1.81] |
| BEAM V2 | +12.22m | [2.51, 0.91, 2.91, 3.51, 1.11] |

Оба алгоритма выбирают **положительные углы** (1-3°).

### Stage 0 debug (BEAM)

```
DEBUG Stage 0: 676/676 good scores, 0 penalties
Good scores: min=-1000054.062, max=-4.112
Top 1: angles=['2.31', '1.71'], score=-4.112
Top 2: angles=['2.31', '1.51'], score=-4.157
Top 3: angles=['2.11', '1.71'], score=-4.247
```

- Все 676 комбинаций имеют валидные scores (нет penalty -1e9)
- Top кандидаты все с углами около +2°
- Это ПРАВИЛЬНОЕ направление (совпадает с BF)

### Проблема

BEAM выбирает похожее направление (положительные углы), но НЕ ТУ комбинацию:
- BF находит углы [1.31, 2.71, 3.31...] → +0.20m
- BEAM находит углы [2.31, 1.71...] → +12.22m

Это проблема **локального минимума** - BEAM застревает в suboptimal решении.

### Гипотезы

1. **beam_width=100 недостаточно** - правильная комбинация выпадает из топ-100
2. **Stage-by-stage accumulation** - ошибки накапливаются
3. **Score != endpoint error** - лучший score на stage 0 не гарантирует лучший финал

### Следующие шаги

1. Сравнить углы BF и BEAM посегментно
2. Проверить где расходятся пути
3. Попробовать beam_width=200/500

---

## [2026-01-17 18:30] Посегментное сравнение Well498

### Ключевое наблюдение

Ошибка начинает накапливаться с **сегмента 11 (MD 4205-4251)**:

| Сегмент | MD range | BEAM angle | BF angle | Δ angle | err_diff |
|---------|----------|------------|----------|---------|----------|
| 11 | 4205-4251 | **3.71°** | 1.51° | +2.20° | +1.89m (первый скачок!) |
| 12 | 4251-4294 | 2.71° | 1.51° | +1.20° | +2.78m |
| 15 | 4408-4429 | **-0.09°** | 2.11° | -2.20° | +1.92m |
| 16 | 4429-4479 | **3.51°** | 0.91° | +2.60° | +4.18m |
| 18 | 4506-4529 | **4.51°** | 2.11° | +2.40° | +5.34m |
| 28 | 5071-5114 | **4.51°** | 0.96° | +3.55° | +10.99m |

### Паттерн

BEAM систематически выбирает **более крутые положительные углы**, особенно после MD 4200.
BF держит углы близко к 1-2°, BEAM скачет до 3-4.5°.

**Гипотеза:** Stage score (Pearson+MSE на lookback) не коррелирует с endpoint error.
BEAM оптимизирует локальную метрику, которая не отражает качество траектории.

### Следующие шаги

1. ~~**Увеличить beam_width** - попробовать 200/500~~ → **Не помогает!** Результат тот же.
2. **Добавить diverse beam** - выбирать разнообразные кандидаты по углам
3. **Увеличить lookback** - текущие 300 точек слишком мало

---

## [2026-01-17 18:30] Где BF путь выпадает из beam

### Эксперимент

Трекинг BF пути при beam_width=200:

```
Stage 0: BF [1.31, 2.71] at rank 106, score=-7.859 ✓ (попал в beam)
Stage 1: BF path LOST! (не попал в топ-200)
```

### Анализ

BF решение выпадает **уже на Stage 1** даже с beam_width=200!

**Причина:**
- BF продолжение [3.31, 1.71] имеет плохой score
- Score = Pearson + MSE на lookback=300 точек (~2 сегмента)
- Эта метрика не коррелирует с endpoint error

### STD анализ (Stage 0)

```
BEAM top-1: [2.31, 1.71], score=-4.11, STD=nan (мало данных)
BF solution: [1.31, 2.71], score=-7.86 (rank 106), STD=7.04 (rank 393)
```

STD тоже не выбирает BF! BF имеет высокий STD.

### Выводы

1. **Score (Pearson+MSE) не коррелирует с endpoint error**
2. **STD не помогает** - BF имеет высокий STD
3. **beam_width=100/200/500 - результат идентичный** (+12.22m)
4. **BF выпадает на Stage 1** - проблема не в Stage 0

### Идеи для улучшения

1. **Diverse beam** - выбирать кандидаты с разными углами, не только топ по score
2. **Увеличить lookback** - смотреть дальше назад
3. **End-to-end метрика** - оценивать всю траекторию, не локальные блоки
4. **Shift penalty** - штраф за накопление shift

---

## [2026-01-17 18:50] first_block_size=4 и STD анализ

### Эксперименты

**С 4 сегментами (456k комбинаций):**

```
BF [1.31, 2.71, 3.31, 1.71]: score=-6.27, rank 96431/456976, STD=10.55
Top-1 [2.31, 1.31, 2.71, 3.31]: score=-1.63, STD=10.33
```

**Ключевые наблюдения:**

1. **STD почти одинаковый** (10.55 vs 10.33) - не различает BF и Top-1
2. **Score сильно разный** (-6.27 vs -1.63) - BF хуже в ~4 раза
3. **Паттерн сдвига:**
   - BF:    [**1.31, 2.71, 3.31**, 1.71]
   - Top-1: [2.31, **1.31, 2.71, 3.31**]

   Top-1 содержит углы BF seg0-2 сдвинутые на 1 позицию!

4. **Все Top-5 заканчиваются на 3.31** (= BF seg2)

### Сравнение с REF интерпретацией

| seg | BF angle | REF angle | BEAM Top-1 |
|-----|----------|-----------|------------|
| 0 | 1.31 | 1.91 | 2.31 |
| 1 | 2.71 | 1.91 | 1.31 |
| 2 | 3.31 | 2.66 | 2.71 |
| 3 | 1.71 | 2.75 | 3.31 |

BF близок к REF, но BEAM "сдвинут" на 1 сегмент.

### Гипотеза

Проблема может быть в **разнице сегментации** между BF и BEAM:
- BF работает по блокам с block_overlap
- BEAM обрабатывает всю скважину с PELT сегментацией

Разные начальные MD → разные сегменты → BEAM оптимизирует "не те" границы.

---

---

## [2026-01-17 19:05] КРИТИЧЕСКАЯ НАХОДКА - LANDING_MODE

### Причина расхождения BEAM vs BF

**Проблема:** BF и BEAM использовали РАЗНЫЕ стартовые точки!

| Поле | Значение | Используется |
|------|----------|--------------|
| landing_end_87_200 | 3773.5 | BF (явно) |
| landing_end_dls | 3756.4 | BEAM (по умолчанию) |

**Разница 17м** = длина "лишнего" сегмента 0 у BEAM.

### Эксперимент с LANDING_MODE=87_200

```bash
LANDING_MODE=87_200 python full_well_optimizer.py --well Well498~EGFDL ...
```

**Результаты:**

| Метрика | LANDING_MODE=dls | LANDING_MODE=87_200 |
|---------|------------------|---------------------|
| zone_start | 3756.4 | **3773.5** |
| n_segments | 30 | **29** |
| BF rank | 96431/456k | **14/456k** |
| opt_error | +12.22m | **+0.10m** |

**BF решение [1.31,2.71,3.31,1.71] теперь в топ-15!**

### Вывод

Нужно использовать `LANDING_MODE=87_200` для совместимости с BF результатами.
По умолчанию `LANDING_MODE='dls'` даёт другую сегментацию.

### Следующий шаг

Установить `LANDING_MODE=87_200` как стандарт для всех алгоритмов.

**ПРОБЛЕМА:** BruteForce оптимизатор падает с segfault при любых параметрах. Нужно отдельно исследовать.

---

## Заметки

- BF прогон воспроизведения 5.37m завершён: RMSE 5.63m, 86/100 wells
- BEAM не использует block_overlap (обрабатывает всю скважину сразу)
- **РЕШЕНО:** Разница landing_end_dls vs landing_end_87_200 была причиной расхождения
- **BUG:** BRUTEFORCE оптимизатор падает с segfault (2026-01-17)

---

## [2026-01-17 23:30] Анализ: как BF решение "всплывает" на 5 сегментах

### Эксперимент Well498 (dls mode)

Запустили BF с 3, 4, 5 сегментами на блок. Искали решение-победителя с 5 сегментов в топ-100 при меньшем количестве сегментов.

| Сегментов | Топ-1 победитель | REF[5seg] ранг | REF Pearson | REF MSE | REF STD |
|-----------|------------------|----------------|-------------|---------|---------|
| 3 | [2.31,2.11,1.11] | **32/100** | 0.657 | 0.610 | **10.95** |
| 4 | [2.31,1.31,2.71,3.31] | **12/100** | 0.746 | 0.492 | **10.34** |
| 5 | [2.31,2.11,1.51,3.91,-0.09] | **1/100** | 0.753 | 0.476 | **10.36** |

### Ключевые наблюдения

1. **REF поднимается**: 32 → 12 → 1 место с увеличением сегментов
2. **STD стабилен** у REF (~10.3-10.9), а у топ-1 на 3seg STD=11.12 (хуже)
3. На 4 сегментах метрики уже почти равны топ-1
4. **Score не отличает** правильное решение на малом числе сегментов

### Гипотеза для улучшения BEAM

Если на ранних стадиях (3-4 сегмента) сохранять разнообразие по **STD** (не только по Score), то правильные решения не будут теряться.

Идея: **Diverse beam** - выбирать топ по Score + топ по низкому STD

---

## [2026-01-17 23:40] BEAM Stage 0: REF[5seg] на 7 месте!

### Эксперимент

Добавили логирование REF[5seg] позиции в BEAM. Результат:

```
Stage 0 (4 сегмента), n_combos=456,976:
  Top-1: [2.31,1.31,2.71,3.31] score=-1.627, STD=10.33
  REF[5seg]: [2.31,2.11,1.51,3.91] rank=7/456976, score=-1.712, STD=10.34
  BF: [1.31,2.71,3.31,1.71] rank=96431/456976, STD=10.55
```

### Ключевое наблюдение

**REF[5seg] попадает в топ-100 на Stage 0 (ранг 7)!**

Но финальный результат BEAM = +12.21m (тот же что и раньше).

Значит REF[5seg] путь теряется на **последующих стадиях** (Stage 1+), а не на Stage 0.

### Гипотеза

На Stage 1 (сегменты 4-5) BEAM добавляет к топ-100 кандидатам 676 вариантов углов.
Для REF[5seg] нужны углы [-0.09, ...] на сегменте 4, но:
- lookback смотрит только на 300 точек (~2 сегмента)
- Комбинация [2.31,2.11,1.51,3.91] + [-0.09, ...] может иметь плохой локальный score

### Следующий шаг

Нужно отследить REF[5seg] путь на Stage 1: какие продолжения есть и на каком месте они?

---

## [2026-01-17 23:40] BEAM: REF[5seg] теряется на Stage 1

### Трекинг REF[5seg] пути

```
Stage 0: REF[5seg] path FOUND at rank 7/100 ✓
Stage 1: REF[5seg] path LOST! ✗
```

### Анализ

- На Stage 0 (4 сегмента) REF[5seg]=[2.31,2.11,1.51,3.91] попадает на 7 место
- На Stage 1 добавляются сегменты 4-5, нужен угол -0.09 на сегменте 4
- Но топ-5 на Stage 1: все углы положительные [2.71,1.71], [2.11,1.71], [2.31,1.71]
- Комбинация REF_prefix + [-0.09,...] имеет плохой локальный score и выпадает

### Выводы

1. **Проблема не в Stage 0** - REF попадает в топ-100
2. **Проблема в Stage 1** - продолжение REF выпадает из топ-100
3. **Причина**: lookback=300 точек смотрит только на ~2 сегмента
4. **Решение**: нужно учитывать качество по бОльшему окну или по всей траектории

### Идеи для улучшения

1. **Увеличить lookback** до 600+ точек (сейчас 300)
2. **Diverse beam по STD** - на Stage 1 сохранять разнообразие по STD
3. ~~**first_block_size=5**~~ - не работает (OOM на 11.8M комбинаций)
4. **End-to-end score** - оценивать качество по всей траектории на каждой стадии

---

## [2026-01-17 23:42] Эксперименты с first_block_size=5

### Попытка 1: angle_step=0.1 (11.8M комбинаций)
→ **OOM** на 3090 (24GB)

### Попытка 2: angle_step=0.4 (371k комбинаций)
→ REF[5seg] на **404 месте** (не в топ-100) из-за потери точности grid

### Вывод

Увеличение first_block_size требует chunked processing для сохранения точности.
Без chunked processing - либо OOM, либо потеря точности.

### Текущий статус анализа

| Стадия | Сегменты | REF[5seg] позиция | Статус |
|--------|----------|-------------------|--------|
| Stage 0 (4 seg) | 0-3 | **7/456976** | ✓ В топ-100 |
| Stage 1 (2 seg) | 4-5 | LOST | ✗ Выпадает |

**Проблема:** Продолжение REF с углом -0.09 на сегменте 4 имеет плохой локальный score.

---

## [2026-01-17 23:45] Финальные выводы анализа Well498

### Сводная таблица BF по сегментам (angle_step=0.2, 26 вариантов на сегмент)

| Сегментов | Формула | Всего комбинаций | REF[5seg] ранг | REF[5seg] ранг из всех | Финал |
|-----------|---------|------------------|----------------|------------------------|-------|
| 3 | 26³ | **17,576** | 32/100 | 32/17576 | +12.04m |
| 4 | 26⁴ | **456,976** | 12/100 | ~12/456976 | +8.89m |
| 5 | 26⁵ | **11,881,376** | **1/100** | 1/11881376 | **+0.27m** |

REF[5seg] = [2.31, 2.11, 1.51, 3.91, -0.09] (победитель на 5 сегментах)

### Сводная таблица BEAM

| Стадия | Сегменты | Формула | Всего комбинаций | REF ранг | REF score | Top-1 score | Статус |
|--------|----------|---------|------------------|----------|-----------|-------------|--------|
| Stage 0 | 0-3 (4 seg) | 1 × 26⁴ | **456,976** | 7/456976 | -1.712 | -1.627 | ✓ В топ-100 |
| Stage 1 | 4-5 (+2 seg) | 100 × 26² | **67,600** | **62266/67600** | **-41.242** | -2.758 | ✗ Почти в конце! |

**КРИТИЧЕСКОЕ НАБЛЮДЕНИЕ:** На Stage 1 REF продолжение [-0.09,-0.29] имеет score=-41.2 против -2.76 у топ-1.
Это разница в **15 раз**! REF на 62266 месте из 67600 (92% от конца).

### Почему REF "всплывает" на 5 сегментах?

На 3 сегментах REF[5seg][:3] = [2.31, 2.11, 1.51] → ранг 32
На 4 сегментах REF[5seg][:4] = [2.31, 2.11, 1.51, 3.91] → ранг 12
На 5 сегментах REF[5seg] = [2.31, 2.11, 1.51, 3.91, -0.09] → **ранг 1**

**Вывод:** Только на 5 сегментах метрики "видят" преимущество REF. На 3-4 сегментах score не различает.

### Почему BEAM теряет REF на Stage 1?

**BF подход (5 сегментов за раз):**
- Оценивает все 11.8M комбинаций одновременно
- Видит полную картину первого блока
- REF на 1 месте → финал +0.27m

**BEAM подход (4 сегмента + 2 сегмента последовательно):**
- Stage 0: оценивает 456k комбинаций, REF на 7 месте ✓
- Stage 1: для каждого из 100 кандидатов оценивает 676 продолжений
- Продолжение REF_prefix + [-0.09, ...] имеет плохой локальный score
- REF выпадает → финал +12.21m

**Проблема:** Локальная метрика (Pearson + MSE на 300 точек) не видит преимущество угла -0.09 на сегменте 4. Эта метрика оптимизирует локальное качество, а не финальный endpoint error.

### Сравнение метрик

| Метрика | REF на Stage 0 | REF продолжение Stage 1 | Top-1 Stage 1 |
|---------|----------------|-------------------------|---------------|
| Углы | [2.31,2.11,1.51,3.91] | [-0.09,-0.29] | [2.71,1.71] |
| Score | -1.712 | **-41.242** | -2.758 |
| Ранг | 7/456976 | **62266/67600** | 1/67600 |

**Вывод:** Отрицательные углы [-0.09,-0.29] катастрофически ухудшают локальный score.
Lookback=300 точек смотрит только на ~2 последних сегмента и не видит общую картину.
BF с 5 сегментами видит всю картину первого блока и выбирает REF как топ-1.

---

## [2026-01-18 00:05] ПРОРЫВ: Инкрементальный MSE

### Проблема (была)

MSE считался **только по новым 2 сегментам**, а Pearson по всем. Это давало несимметричную оценку.

### Решение

Добавили инкрементальный MSE:
- В BeamPrefix: `sse` (сумма квадратов ошибок), `n_points`
- full_mse = (prefix.sse + new_sse) / (prefix.n_points + new_n)
- Вычислительно бесплатно (одно сложение и деление)

### Результат

| Метрика | До | После |
|---------|-----|-------|
| REF score Stage 1 | -41.2 | **-22.4** |
| REF ранг Stage 1 | 62266/67600 | 62263/67600 |
| **Финальный opt_error** | **+12.21m** | **+0.02m** |

**Улучшение: 99.8%!**

REF путь всё ещё теряется на Stage 1, но накопленный MSE направляет BEAM к лучшему финальному решению!

### Ключевой вывод

**Score (Pearson + MSE на lookback=300) не коррелирует с endpoint error.**

На Stage 1 BEAM добавляет сегменты 4-5. Для REF нужен угол -0.09 на seg4.
Но комбинация REF_prefix + [-0.09,...] имеет плохой score и выпадает из топ-500.

### Что не помогает

- ❌ beam_width=100/200/500 - результат идентичный
- ❌ first_block_size=5 - OOM на 11.8M комбинаций
- ❌ angle_step=0.4 - потеря точности, REF на 404 месте

### Идеи для улучшения

1. **Diverse beam** - сохранять разнообразие по углам/STD, не только топ по score
2. **End-to-end score** - оценивать качество по всей траектории
3. **Shift penalty** - штрафовать накопление shift
4. **Chunked first_block** - реализовать chunked processing для 5+ сегментов

---

## [2026-01-18 00:15] Результаты инкрементального MSE на 18 тестовых скважинах

### Run ID: 20260118_001009

**Команда:**
```bash
CUDA_VISIBLE_DEVICES=1 python full_well_optimizer.py --wells Well1093~ASTNL Well1143~ASTNL ... --algorithm LOOKBACK_BEAM_V2
```

### Ключевые улучшения

| Well | Old BEAM | New BEAM | Delta |
|------|----------|----------|-------|
| **Well1615~EGFDL** | -13.54m | **-0.04m** | **+13.50m** |
| **Well498~EGFDL** | +12.22m | **+0.02m** | **+12.20m** |
| Well131~EGFDL | -18.12m | -12.98m | +5.14m |
| Well1675~EGFDL | +22.31m | +19.57m | +2.74m |

### Полные результаты (18 скважин)

| Метрика | Значение |
|---------|----------|
| Baseline RMSE | 11.69m |
| BEAM V2 RMSE (incremental MSE) | **9.77m** |
| Improvement | **16.4%** |
| Wells improved | 12/18 (67%) |

### Per-well results

| Well | opt_error | baseline | Улучшен? |
|------|-----------|----------|----------|
| Well1093~ASTNL | -12.11m | -8.55m | ✗ |
| Well1143~ASTNL | -0.28m | +3.58m | ✓ |
| Well1153~EGFDL | +13.68m | +14.30m | ✓ |
| Well115~EGFDL | +3.75m | +8.12m | ✓ |
| Well1235~EGFDL | +5.51m | +7.90m | ✓ |
| Well131~EGFDL | -12.98m | -8.42m | ✗ |
| Well1333~ASTNL | -2.63m | +3.51m | ✓ |
| Well1509~EGFDL | -2.48m | +2.79m | ✓ |
| Well156~EGFDL | +3.71m | -1.89m | ✗ |
| Well1613~EGFDL | +0.75m | -4.99m | ✓ |
| Well1615~EGFDL | -0.04m | -4.31m | ✓ |
| Well166~EGFDL | -1.21m | -0.70m | ✗ |
| Well1675~EGFDL | +19.57m | +24.21m | ✓ |
| Well1890~EGFDL | +6.34m | -3.98m | ✗ |
| Well1898~EGFDU | -24.07m | -29.04m | ✓ |
| Well460~EGFDL | +11.85m | +5.91m | ✗ |
| Well498~EGFDL | +0.02m | +16.37m | ✓ |
| Well916~EGFDL | -0.21m | -12.39m | ✓ |

### Выводы

1. **Инкрементальный MSE работает!** Два ключевых проблемных well (498 и 1615) теперь дают отличные результаты
2. Улучшение 16.4% от baseline на 18 тестовых скважинах
3. Некоторые скважины всё ещё хуже baseline - требуют дополнительного исследования

---

## [2026-01-18 00:20] ПОЛНЫЙ ПРОГОН: 100 скважин с инкрементальным MSE

### Run ID: 20260118_001552

### Итоговые результаты

| Метрика | Значение |
|---------|----------|
| Baseline RMSE | 6.93m |
| **BEAM V2 RMSE (incr MSE)** | **6.01m** |
| Improvement vs baseline | **13.2%** |
| Wells improved | **56/100 (56%)** |

### Сравнение с предыдущими результатами

| Алгоритм | RMSE | Wells improved | Время |
|----------|------|----------------|-------|
| Baseline | 6.93m | - | - |
| BF best_std | **5.37m** | 86/100 | ~6400s |
| GREEDY_BF | 6.62m | 54/100 | ~500s |
| BEAM V2 (old) | 6.25m | 53/100 | ~540s |
| **BEAM V2 (incr MSE)** | **6.01m** | **56/100** | ~120s |

### Ключевые выводы

1. **Инкрементальный MSE улучшил RMSE на 3.8%** (6.25m → 6.01m)
2. **Количество улучшенных скважин выросло** с 53 до 56
3. **BEAM V2 приблизился к BruteForce** (6.01m vs 5.37m = разница 11.9%)
4. **Скорость: ~1.2s/well** (vs ~64s/well для BruteForce)

### Что осталось

Разница с BruteForce всё ещё 0.64m (11.9%). Возможные направления:
1. Diverse beam (сохранение разнообразия по STD)
2. Увеличение beam_width для первых стадий
3. End-to-end score на финальных стадиях

---

## [2026-01-18 00:25] Анализ: изменения в хит-параде проблемных скважин

### FIXED инкрементальным MSE (4 скважины!)

| Well | Было (BEAM-BF) | Стало | Результат |
|------|----------------|-------|-----------|
| Well1615 | +12.47m | **-1.03m** | BEAM лучше BF! |
| Well498 | +12.02m | **-0.18m** | BEAM лучше BF! |
| Well131 | +6.12m | **+0.98m** | Почти равны |
| Well1675 | +0.45m | **-2.29m** | BEAM лучше BF! |

### Остались проблемными (4 скважины - приоритет для исследования)

| Well | BEAM-BF diff |
|------|--------------|
| Well1153~EGFDL | +11.53m |
| Well1093~ASTNL | +10.77m |
| Well460~EGFDL | +7.40m |
| Well1898~EGFDU | +4.23m |

### Новые проблемные (4 скважины - появились после фикса)

| Well | BEAM-BF diff |
|------|--------------|
| Well1781~EGFDL | +8.50m |
| Well1416~EGFDU | +6.39m |
| Well189~EGFDL | +5.72m |
| Well576~EGFDL | +5.49m |

### BEAM побеждает BF (для понимания что работает)

| Well | BEAM-BF diff |
|------|--------------|
| Well1613~EGFDL | -8.28m |
| Well239~EGFDL | -6.88m |
| Well1401~EGFDL | -6.44m |
| Well1143~ASTNL | -5.96m |

### Новый список тестовых скважин (16 шт)

```
Well1153~EGFDL Well1093~ASTNL Well460~EGFDL Well1898~EGFDU Well1781~EGFDL Well1416~EGFDU Well189~EGFDL Well576~EGFDL Well1615~EGFDL Well498~EGFDL Well131~EGFDL Well1675~EGFDL Well1613~EGFDL Well239~EGFDL Well1401~EGFDL Well1143~ASTNL
```

**Старый список 18 скважин оставить для регрессии!**

---

## [2026-01-18 00:40] КРИТИЧЕСКОЕ ОТКРЫТИЕ: BEAM уже лучше BF!

### Проблема сравнения

Раньше сравнивали:
- BEAM (dls mode): 6.01m
- BF (87_200 mode): 5.37m

**Это некорректно!** Разный landing mode = разная сегментация = несравнимые результаты.

### Честное сравнение (оба DLS mode)

| Метрика | BEAM | BF |
|---------|------|-----|
| **RMSE** | **6.01m** | 6.45m |
| Wells better | **34** | 25 |
| Same (±0.5m) | 41 | 41 |
| **Результат** | **BEAM выигрывает на 0.44m (7%)!** |

### TOP-10 где BEAM хуже BF (приоритет для исследования)

| Well | BEAM | BF | Diff |
|------|------|-----|------|
| Well1093~ASTNL | -12.11m | -2.27m | +9.84m |
| Well1781~EGFDL | -12.78m | -4.28m | +8.50m |
| Well42~EGFDL | +10.11m | -1.64m | +8.47m |
| Well460~EGFDL | +11.85m | -5.76m | +6.09m |
| Well1890~EGFDL | +6.34m | +1.01m | +5.33m |

### TOP-5 где BEAM лучше BF

| Well | BEAM | BF | Diff |
|------|------|-----|------|
| Well1613~EGFDL | +0.75m | +8.95m | -8.20m |
| Well1898~EGFDU | -24.07m | -31.84m | -7.77m |
| Well239~EGFDL | -4.85m | -11.71m | -6.86m |
| Well1401~EGFDL | -0.21m | +6.59m | -6.38m |
| Well131~EGFDL | -12.98m | -18.98m | -6.00m |

### Выводы

1. **BEAM с инкрементальным MSE УЖЕ лучше BF при честном сравнении!**
2. Разница 5.37m vs 6.01m была артефактом разного landing mode
3. Осталось 25 скважин где BEAM хуже - потенциал для улучшения ещё ~0.5m

---

## [2026-01-18 00:50] Детальный анализ Well1093

### Сегментное сравнение (оба DLS mode)

```
BEAM: opt_error=-12.11m, n_seg=22
BF:   opt_error=-2.27m, n_seg=22
Zone start: обе 3804.3 (одинаковый!)
```

### Где divergence начинается

| seg | MD | BEAM | BF | Δ_angle | shift_diff |
|-----|-----|------|-----|---------|------------|
| 0 | 3804 | -3.00° | -3.10° | +0.10° | +0.16m |
| 1 | 3892 | **-2.00°** | **-1.60°** | -0.40° | -0.07m |
| 2 | 3924 | **-2.60°** | **-1.60°** | -1.00° | **-2.75m** |
| 3 | 4077 | **-3.80°** | **-1.60°** | -2.20° | **-3.80m** |

**BF выбирает одинаковый угол -1.60° на seg 1-3!**
BEAM выбирает разные более крутые углы: -2.00°, -2.60°, -3.80°

### Накопление ошибки

К сегменту 11-12 разница достигает **-11.36m**, и далее только растёт.

### Ключевая проблема

**Та же что с Well498**: локальный score (Pearson + MSE на lookback) предпочитает более крутые углы, которые хуже глобально.

Инкрементальный MSE помог Well498, но не помог Well1093. Возможно:
1. Нужен более длинный lookback
2. Нужна другая комбинация Pearson/MSE весов
3. Нужен diverse beam (сохранение разнообразия)

### Гипотеза

BF решение [-3.10, -1.60, -1.60, -1.60] имеет плохой локальный score на первых 4 сегментах, поэтому BEAM его не выбирает. Нужно найти где это решение в рейтинге BEAM Stage 0.
