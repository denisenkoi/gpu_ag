# GPU AG - Worksheet

## Текущие задачи

- RND-792: Сглаживание GR
- RND-790: Улучшение функции награды (комментарий добавлен)

---

## [2025-12-23 12:45] Начало нового блока работ

### Следующие шаги

1. **Сглаживание GR (RND-792)**
   - Гипотеза: гладкая GR → гладкий ландшафт → стабильнее оптимизация

2. **Другие методы оптимизации**
   - scipy.minimize (L-BFGS-B, Powell)
   - optuna
   - Комбинации алгоритмов

3. **Улучшение objective function**
   - Проблема: objective не коррелирует с RMSE (отрицательная корреляция!)

---

## Заметки

---

## [2025-12-23 14:26] Тест 243 vs 867 популяций

**Исправлено:**
1. Добавлен `load_dotenv()` в slicer.py (не загружался .env)
2. Добавлены GPU параметры в cpu_baseline/.env
3. Исправлено логирование: fun + evals вместо correlation

**Сравнение (Well1798~EGFDL, 1 итерация):**

| Метрика | 867 pop (range=10°) | 243 pop (range=5°) |
|---------|---------------------|---------------------|
| RMSE | 0.227м | 0.226м |
| Max dev | 0.715м | 0.714м |
| Total evals | 346,800 | 194,400 |
| Время | ~16 мин | ~2 мин |

**Вывод:** Качество идентичное при range=5° vs range=10°. Скорость в 8 раз выше.

---

## [2025-12-23 15:20] Расширенное логирование CSV

**Добавлено:**
1. `eval_count` в `TorchObjectiveWrapper` - фактическое количество evaluations
2. Детальное логирование в `_log_optimization_result`:
   - MD range (start_md - end_md)
   - fun (objective)
   - pearson, mse
   - angle_penalty, angle_sum_penalty
   - angles (список углов сегментов)
   - actual_evals / expected_evals

**CSV формат:** `results_wells_grid_15/optimization_statistics.csv`
```
timestamp,well_name,step_type,start_md,end_md,segments_count,fun,pearson,mse,angle_penalty,angle_sum_penalty,angles,actual_evals,expected_evals,elapsed_time,success
```

**Тест полной скважины (multi-center):** 22/~45 итераций выполнено, затем StarSteer crash.

**Результат:** CSV формат работает корректно, все метрики записываются.

---

## [2025-12-23 17:55] Single CMA-ES mode

**Добавлено:**
- `GPU_CMAES_MODE=single|multi` - выбор режима CMA-ES
- `GPU_SINGLE_POPSIZE=2000` - размер популяции для single mode

**Сравнение (тест Well1798~EGFDL):**

| Metric | Single (pop=2000) | Multi (243×8) |
|--------|-------------------|---------------|
| Time/step | **0.27s** | 63s |
| Speedup | **230x** | 1x |
| Evals/step | 100,000 | 97,200 |
| RMSE тренд | растёт | растёт |

**Вывод:** Single mode даёт **230x speedup** при том же качестве!
Рост RMSE - проблема objective function (RND-790), не алгоритма.

---

## [2025-12-23 19:07] Тест повторяемости - ЗАВЕРШЕНО

**5 прогонов выполнено** (4 полных):

| Run | Steps | fun mean | fun max | pearson |
|-----|-------|----------|---------|---------|
| 2 | 44 | 0.0075 | 0.065 | 0.597 |
| 3 | 43 | 0.0036 | 0.015 | 0.617 |
| 4 | 44 | 0.0072 | 0.068 | 0.605 |
| 5 | 43 | 0.0063 | 0.065 | 0.606 |

### Сравнение интерпретаций

| Runs | Identical (<0.01m) | Close (<0.1m) | Max diff |
|------|-------------------|---------------|----------|
| 2 vs 3 | 76% | 82% | 6.87m |
| 2 vs 4 | 80% | 81% | 9.71m |
| 2 vs 5 | 83% | 90% | 1.31m |
| 3 vs 4 | 66% | 73% | 13.77m |
| 3 vs 5 | 76% | 85% | 7.76m |
| 4 vs 5 | 69% | 76% | 9.71m |

**Лучшая пара:** Run 2 vs 5 (90% close, max diff 1.31m)
**Худшая пара:** Run 3 vs 4 (73% close, max diff 13.77m)

### Выводы

1. **Повторяемость:** 66-90% (зависит от того, попал ли алгоритм в локальный минимум)
2. **Max расхождение:** до 13.77m в худшем случае
3. **Причина:** стохастичность CMA-ES на "плохих" данных (низкий pearson)

### Исправлен баг race condition

Добавлено 10 retry с интервалом 0.5s в `_wait_for_fresh_data_file()` для обработки атомарной перезаписи файла StarSteer.

### Итоги Single CMA-ES mode

| Метрика | Значение |
|---------|----------|
| Speedup | **230x** |
| Повторяемость | 66-90% |
| Качество | Эквивалентно multi-center |

**Следующие шаги:**
1. Добавить retry при fun > threshold
2. Исследовать сглаживание GR (RND-792)
3. Улучшить objective function (RND-790)

---

## [2025-12-23 19:35] Эксперимент с LOOKBACK

**PYTHON_LOOKBACK_DISTANCE=200м** (было 50м):

| Метрика | 50м | 200м |
|---------|-----|------|
| pearson (конец) | 0.03-0.22 | **0.70-0.80** |
| углы (конец) | +1.67° | **-2.5°** ✓ |
| fun max | 0.065-0.091 | **0.019** |
| Segments | 145-148 | 57 |

**Вывод:** lookback=200м даёт правильные углы (~-2.5°) и лучший pearson.
