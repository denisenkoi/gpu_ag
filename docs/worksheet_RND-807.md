# GPU AG - Worksheet

## Текущие задачи

- RND-802: Monte Carlo optimizer (тестирование)
- RND-803: PSO optimizer (тестирование)

---

## [2025-12-27 13:31] Текущие baseline метрики (Well1798~EGFDL)

| Алгоритм | RMSE | Delta | Coverage 3m | time/slice |
|----------|------|-------|-------------|------------|
| **CMA-ES** | 2.43m | 4.70m | 69.8% | 0.28s |
| PSO 2000 | 3.17m | 4.70m | 63.0% | 7.4s |

---

## [2025-12-27 14:XX] Анализ скважин с RMSE 100+ метров

**Jira:** RND-805 (Bug) - привязан к эпику RND-770

### Найдены 11 проблемных скважин

Из прогона 98 скважин (slicer_all_wells_v2.log):

| Скважина | Max RMSE | Примечание |
|----------|----------|------------|
| **Well1509~EGFDL** | **344.2m** | Худшая скважина! |
| Well1466~EGFDL | 275.6m | |
| Well1150~EGFDL | 267.2m | Два скачка на MD=4035m и 4515m |
| Well1401~EGFDL | 265.7m | |
| Well1736~EGFDL | 223.8m | |
| Well1300~EGFDL | 168.6m | |
| Well1322~EGFDL | 166.6m | |
| Well809~EGFDL | 157.0m | |
| Well530~EGFDL | 156.5m | |
| Well1615~EGFDL | 129.8m | |
| Well1258~EGFDL | 107.5m | |

### Детальный анализ Well1150~EGFDL

**Паттерн ошибки:**
1. MD=3974.9m: RMSE=0.33m ← нормально
2. MD=4004.8m: RMSE=0.58m ← нормально
3. **MD=4034.9m: RMSE=228.6m** ← СКАЧОК!
4. MD=4064.8m: RMSE=9.8m ← частичное восстановление
5. ... стабильно 7-10m ...
6. **MD=4514.7m: RMSE=267.2m** ← второй СКАЧОК!
7. ... далее 100-140m

**Причина (MD=4034.9m):**
```
fun = 1229.7 (очень высокий!)
Ref Shift:  9.91 ft
Comp Shift: 241.16 ft  ← оптимизатор ушёл в локальный минимум
Pearson: 0.82 (хорошая корреляция, но в НЕПРАВИЛЬНОЙ точке!)
```

**Гипотезы:**
1. CMA-ES застрял в локальном минимуме
2. Проблема с грид/данными в этой области (ложные корреляции)
3. Каротаж/typewell плохо матчатся на этом участке

### Детальный анализ Well1509~EGFDL (худшая скважина)

**Паттерн ошибки:**
1. MD=3954.8m: RMSE=0.68m ← нормально
2. **MD=3985.0m: RMSE=148.5m** ← СКАЧОК!
3. MD=4014.8m: RMSE=0.66m ← ВОССТАНОВИЛОСЬ!
4. **MD=4044.7m: RMSE=344.2m** ← второй СКАЧОК (max!)
5. MD=4074.9m: RMSE=193.8m ← "залип" на ~195-200m до конца скважины

**Ключевое наблюдение:**
- Первый скачок ВРЕМЕННЫЙ - алгоритм восстановился
- Второй скачок ПЕРМАНЕНТНЫЙ - алгоритм застрял в ложном минимуме
- После застревания RMSE стабильно ~195-200m до конца (40+ шагов!)

**Возможная причина:**
- Ложная корреляция в точке MD≈4045m
- Prefix сегменты "затягивают" оптимизацию в неправильную область
- Lookback 200m включает ошибочные сегменты → плохая инициализация

### Воспроизведение бага (2025-12-27 14:09)

Запустил CMA-ES на Well1509~EGFDL - баг **воспроизвёлся на первом же шаге!**

```
Iteration 1:
Angles (°): Opt=['71.48', '16.53', '20.69', '-11.46']  ← ОПТИМИЗАТОР ВЫДАЛ!
Ref=['2.21', '2.26', '2.26', '2.26']                   ← ДОЛЖНО БЫТЬ
fun = 6451.568159 (!!!)
```

**ВЫВОД:** Это НЕ проблема застревания в локальном минимуме.
Оптимизатор выдаёт угол **71°**, когда должен быть **2°**.
Это **арифметическая/логическая ошибка** в коде.

### ROOT CAUSE НАЙДЕН (2025-12-27 14:35)

**Проблема:** `initial_bounds` в EvoTorch задаёт ТОЛЬКО инициализацию, НЕ ограничивает результат!

**Доказательство:**
```
Iteration 3:
bounds: lb=[0.01, ...] ub=[15.80, ...]        ← ЗАДАННЫЕ ОГРАНИЧЕНИЯ
RAW shifts: ['120.45', '110.12', ...]         ← РЕЗУЛЬТАТ 120м при ub=16м!!!
```

CMA-ES **свободно выходит за bounds** потому что **hard bounds не заданы**.

**Решение:** Заменить `initial_bounds` на `bounds` в Problem:
```python
# Было (неправильно):
super().__init__(initial_bounds=(lb, ub), ...)

# Нужно:
super().__init__(bounds=(lb, ub), ...)
```

**Каскадный эффект:**
1. Оптимизатор находит ложную корреляцию на шифте ~120m (Pearson=0.66!)
2. Без hard bounds он уходит туда
3. Эти шифты применяются к сегментам
4. На следующем шаге bounds вычисляются на основе новых (неправильных) сегментов
5. Bounds ещё больше расширяются
6. Цикл повторяется

---

## [2025-12-27 15:XX] Продолжение расследования angle_penalty

### Несоответствие objective и angle_penalty

Из лога:
```
Objective    |  2983.711627
AnglePenalty | 3591926.581363
```

По формуле:
- pearson_component = 1 - 0.66 = 0.34
- base = (0.34)^2 × (0.007)^0.001 = 0.115
- objective = 0.115 × (1 + 3.6M) = **414,343**

Но в логе Objective = 2,983 — **разница в 139 раз!**

### Гипотезы

1. ❓ Формула в `compute_detailed` отличается от того что используется
2. ❓ Параметры power передаются неправильно
3. ❓ angle_penalty в логе вычисляется post-hoc, отдельно от objective

### Что точно известно (ROOT CAUSE)

**`initial_bounds` в EvoTorch НЕ ограничивает результат!**
- CMA-ES выходит за bounds: shifts 120м при ub=16м
- Решение: заменить `initial_bounds=(lb, ub)` на `bounds=(lb, ub)`

Это основной фикс. Несоответствие objective/penalty - вторичная проблема.

---

## [2025-12-27 15:40] Эксперимент min_pearson=0.3

### Изменения

1. `.env`: `PYTHON_MIN_PEARSON_VALUE=0.3` (было -1.0)
2. `batch_objective.py`: добавлен clamp в compute_detailed

### Результат на Well1509~EGFDL (та же "сломанная" скважина)

| Алгоритм | RMSE | Delta | AnglePenalty | Coverage 3m |
|----------|------|-------|--------------|-------------|
| CMA-ES (было) | 344m | ~200m | 3.6M | 0% |
| PSO-2000 | 5.1m | 5.4m | 0 | 0% |
| **CMA-ES (min_p=0.3)** | **0.86m** | **0.90m** | **0** | **100%** |

### Анализ

Ограничение `pearson = max(0.3, pearson)` убрало ложный стимул:
- Раньше: слабые/отрицательные корреляции делали objective плохим
- CMA-ES искал точки с хорошим Pearson ЗА ПРЕДЕЛАМИ bounds
- Теперь: все слабые корреляции (<0.3) дают одинаковый вклад
- CMA-ES не мотивирован выходить за bounds

### ВЫВОД (ПРЕДВАРИТЕЛЬНЫЙ)

`min_pearson=0.3` помог Well1509 - нужно проверить на остальных 10 скважинах.

---

## [2025-12-27 16:10] Результаты min_pearson=0.3 на 10 скважинах

### Результаты теста

| Скважина | БЫЛО (RMSE) | СТАЛО (min_p=0.3) | Изменение |
|----------|-------------|-------------------|-----------|
| Well1509* | 344.2m | 0.9m | ✓ **ОТЛИЧНО** |
| Well1322 | 166.6m | 3.7m | ✓ **ОТЛИЧНО** |
| Well809 | 157.0m | 3.8m | ✓ **ОТЛИЧНО** |
| Well1150 | 267.2m | 169.3m | ↓ частично |
| Well1736 | 223.8m | 192.2m | ↓ частично |
| Well1300 | 168.6m | 102.2m | ↓ частично |
| Well1258 | 107.5m | 94.9m | ↓ частично |
| Well1466 | 275.6m | 318.3m | ✗ ХУЖЕ |
| Well1401 | 265.7m | 286.2m | ✗ ХУЖЕ |
| Well530 | 156.5m | 158.1m | ~ без изменений |
| Well1615 | 129.8m | 136.7m | ✗ ХУЖЕ |

*Well1509 тестировалась отдельно ранее

### ВЫВОД

**min_pearson=0.3 НЕ универсальное решение!**

- ✓ Помог 3 из 11 скважин (Well1509, Well1322, Well809)
- ↓ Частично улучшил 4 скважины (остались >90m RMSE)
- ✗ Ухудшил или не изменил 4 скважины

**Причина:** min_pearson убирает стимул искать ложные корреляции, но НЕ ограничивает CMA-ES от выхода за bounds.

**Следующий шаг:** Заменить `initial_bounds` на `bounds` в EvoTorch Problem (hard constraints).

---

## [2025-12-27 23:20] CMA-ES с жёстким ограничением углов (inf)

### Изменения
- `angle_penalty`: мягкий (1000×excess²) → жёсткий (inf при |угол|>10°)
- `min_pearson=0.3` (без изменений)

### Результаты на 4 проблемных скважинах (3 прогона)

| Скважина | soft penalty | hard run1 | hard run2 | hard run3 |
|----------|-------------|-----------|-----------|-----------|
| Well1509 | 0.9m | 34.9m | 40.6m | 40.4m |
| Well1401 | 286m | timeout | 105.9m | 17.3m |
| Well1322 | 3.7m | 15.3m | 19.6m | 57.6m |
| Well809 | 3.8m | 14.3m | 26.5m | 32.2m |

### Выводы

1. **Жёсткое ограничение ухудшает** скважины которые были хорошими с soft penalty
2. **Воспроизводимость CMA-ES очень плохая:**
   - Well1322: 15 → 20 → 58m (разброс 4x)
   - Well1401: timeout → 106 → 17m (разброс 6x)
   - Well809: 14 → 27 → 32m (разброс 2x)
3. CMA-ES застревает в разных локальных минимумах

---

## [2025-12-27 23:50] PSO тест - критическая ошибка

### Проблема

PSO падает на всех скважинах с ошибкой:
```
ValueError: operands could not be broadcast together with shapes (0,) (50,4)
```

**Причина:** Жёсткое ограничение `return inf при |angle| > 10°` убивает все 50 частиц PSO.
- CMA-ES не уважает bounds → нужен inf penalty
- PSO уважает bounds → inf penalty убивает все частицы → best_pos пустой → crash

### Вывод

Жёсткое ограничение (inf) **несовместимо с PSO**. Для PSO нужен мягкий penalty.

---

## [2025-12-28 00:XX] Экспоненциальный penalty вместо inf

### Изменения

Во всех 3 objective файлах заменён жёсткий inf на полумягкий экспоненциальный penalty:

**Формула:** `penalty = 1_000_000 * 100^(max_excess)` где `max_excess = max(0, |angles| - range)`

**Изменённые файлы:**
- `torch_funcs/batch_objective.py` ✓
- `torch_funcs/objective.py` ✓
- `numpy_funcs/objective.py` ✓

**Причина:** PSO падал с inf penalty (все 50 частиц убиваются → best_pos пустой → crash)

### Результаты теста PSO с exp penalty

| Скважина | Результат | RMSE | Примечание |
|----------|-----------|------|------------|
| Well1509 | ❌ CRASH | - | broadcast error |
| Well1401 | ⚠️ частично | 22-32m | обработана до конца |
| Well1322 | ✓ | 4-9m | успешно |
| Well809 | ❌ CRASH | 1-5m | упала в середине |

**Вывод:** Экспоненциальный penalty НЕ решил проблему полностью.
PSO падает когда ВСЕ 50 частиц получают inf (не только angle, но и projection failure).

---

## [2025-12-28 00:27] Ночное тестирование CMA-ES на 11 скважинах

### Результаты прогонов

| Run | Avg RMSE | Max RMSE | Wells | Points | Time |
|-----|----------|----------|-------|--------|------|
| 1 | 26.2m | 104m | 11/11 | 1016 | 28min |
| 2 | 28.1m | 92m | 11/11 | 1018 | 27min |
| 3 | 29.4m | 94m | 11/11 | 1018 | 27min |
| 4 | 29.7m | 129m | 11/11 | 1018 | 27min |
| 5 | 28.1m | 109m | 10/11* | 932 | 26min |

*Run5: 1 скважина упала из-за StarSteer timeout (не алгоритм)

### Итоговая статистика (5 прогонов)

| Метрика | Min | Max | Avg | Разброс |
|---------|-----|-----|-----|---------|
| Avg RMSE | 26.2m | 29.7m | 28.3m | ±6% |
| Max RMSE | 92m | 129m | 106m | ±20% |

### ВЫВОДЫ

1. **Качество**: Avg RMSE ~28m (было 100-344m в baseline) - **улучшение в 4-12x**
2. **Стабильность**: 54/55 скважин обработано (98%) - **хорошо**
3. **Воспроизводимость**: Avg RMSE разброс ±6% - **хорошо**
4. **Max RMSE нестабилен**: 92-129m разброс ±20% - CMA-ES иногда застревает в локальных минимумах

### Конфигурация
- Алгоритм: CMA-ES (SNES)
- min_pearson: 0.3
- angle_penalty: exp (1M×100^x)

---

## [2025-12-28 12:30] Подготовка Grid Search (RND-806)

### Выборка 25 скважин (v2 - рандомная)

Из 84 скважин slicer_all_wells_v2.log выбраны:

| Категория | Кол-во | RMSE range | Метод |
|-----------|--------|------------|-------|
| WORST (>=100m) | 7 | 121-208m | все |
| BAD (50-100m) | 5 | 66-83m | все |
| MEDIUM (10-50m) | 5 | 12-40m | random |
| WEAK (3-10m) | 4 | 3.6-8.7m | random |
| GOOD (<3m) | 4 | 0.2-2.8m | random |

**Распределение:** 12 плохих (48%), 13 остальных (52%)

### Параметры для grid search

| Параметр | Текущее | Варианты |
|----------|---------|----------|
| pearson_power | 2.0 | 1.0, 2.0, 3.0 |
| mse_power | 0.001 | 0.0001, 0.001, 0.01 |
| angle_sum_power | 2.0 | 1.0, 2.0, 3.0 |

**Примечание:** angle_sum_power hardcoded в batch_objective.py:478

---

## Заметки

---
